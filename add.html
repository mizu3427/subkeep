<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Subkeep - サブスクリプション追加</title>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>追加フォーム</h1>

    <form id="subscription-form">
      <label>サービス名</label>
      <input type="text" id="name" required />

      <label>金額（¥）</label>
      <input type="number" id="amount" required />

      <label>頻度</label>
      <select id="frequency">
        <option value="daily">日額</option>
        <option value="monthly">月額</option>
        <option value="yearly">年額</option>
      </select>

      <label>契約日</label>
      <input type="date" id="start-date" required />

      <label>次回支払日（契約終了日）</label>
      <input type="date" id="next-payment-date" required />

      <label>
        <input type="checkbox" id="is-recurring" checked>
        継続契約する
      </label><br>

      <button type="submit">追加</button>
    </form>

    <div class="nav-buttons">
      <a href="index.html" class="nav-button">戻る</a>
    </div>
  </div>

  <!-- Subkeep本体のロジック -->
  <script src="script.js"></script>

  <!-- Google API ライブラリ -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://apis.google.com/js/client.js"></script>

  <!-- Google API 初期化とイベント登録 -->
  <script>
    const GOOGLE_API_KEY = "AIzaSyAvD-I_CTB27OmRz6xxljY3aeKANQopNjc";
    const GOOGLE_CLIENT_ID = "665619032047-4q1bnabklt90fqft9uealaobvnk91rqd.apps.googleusercontent.com";

    function initGoogleAPI() {
      gapi.load("client:auth2", () => {
        gapi.client.init({
          apiKey: GOOGLE_API_KEY,
          clientId: GOOGLE_CLIENT_ID,
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
          scope: "https://www.googleapis.com/auth/calendar.events"
        }).then(() => {
          console.log("Google API 初期化完了");
        }).catch((err) => {
          console.error("Google API 初期化失敗:", err);
        });
      });
    }

    function createCalendarEvent(sub) {
      const event = {
        summary: sub.name,
        description: `Subkeep契約: ¥${sub.amount} / ${sub.frequency}`,
        start: { date: sub.nextPaymentDate },
        end: { date: sub.nextPaymentDate }
      };

      gapi.auth2.getAuthInstance().signIn().then(() => {
        gapi.client.calendar.events.insert({
          calendarId: "primary",
          resource: event
        }).then((res) => {
          console.log("Googleカレンダーに登録完了:", res);
        }).catch((err) => {
          console.error("イベント登録失敗:", err);
        });
      }).catch((err) => {
        console.error("Google認証失敗:", err);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      initGoogleAPI();

      const form = document.getElementById("subscription-form");
      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const name = document.getElementById("name").value.trim();
        const amount = parseFloat(document.getElementById("amount").value);
        const frequency = document.getElementById("frequency").value;
        const startDate = document.getElementById("start-date").value;
        const nextPaymentDate = document.getElementById("next-payment-date").value;
        const isRecurring = document.getElementById("is-recurring").checked;

        if (!name || isNaN(amount)) {
          alert("必要な情報を入力してください");
          return;
        }

        const newSub = { name, amount, frequency, startDate, nextPaymentDate, isRecurring };
        const subs = JSON.parse(localStorage.getItem("subscriptions") || "[]");
        subs.push(newSub);
        localStorage.setItem("subscriptions", JSON.stringify(subs));

        // Googleカレンダーに登録
        createCalendarEvent(newSub);

        // 通知
        if (Notification.permission === "granted") {
          new Notification("Subkeep", { body: `${name} を追加しました` });
        } else if (Notification.permission !== "denied") {
          Notification.requestPermission().then((permission) => {
            if (permission === "granted") {
              new Notification("Subkeep", { body: `${name} を追加しました` });
            }
          });
        }

        window.location.href = "index.html";
      });
    });
  </script>
</body>
</html>
